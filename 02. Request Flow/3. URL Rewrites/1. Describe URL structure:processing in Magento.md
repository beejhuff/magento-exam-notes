# Describe URL structure/processing in Magento



# 1. Overview of table core_url_rewrite

**1. url_rewrite_id**

**2. store_id**

**3. id_path**

Unique id used.
e.g. product/1 or category/1 or 55306700_1436466387 (custom redirect)

**4. request_path**

Path of current URL e.g. sample-product.html

**5. target_path**

Magento path of current URL
e.g. catalog/product/view/id/1 or my-sample-product.html (custom redirect)

**6. is_system**

Is URL created automatically by Magento (used for re-indexing)

**7. options**

Custom redirects would be set as "RP" or "R"


**8. description**

**9. category_id**

Category ID of the URL.

**10. product_id**

Product ID of the URL.

# 2. URL types

So there are 2 URL types

- System
- Custom

**Note:** You can view these under Manage Catalog -> URL Rewrite Management.


## 2.1 System

These are urls generated by Magento for products and categories when you save a product/category.
These use the product/category suffix found under System -> Configuration -> Catalog -> Search Engine Optimisations.

**Example:**

- id_path = product/1
- request_path = my-sample-product.html
- target_path = catalog/product/view/id/1
- is_system = 1
- product_id = 1


## 2.2 Custom

These are redirects either manually created in URL rewrite Management or if change the URL of the product/category and select create redirect option.

- id_path = random_string
- request_path = old-url.html
- target_path = my-sample-product.html
- is_system = 0
- options = RP

So you will notice there is "RP". This stands for permanent redirect. It can also be "R" for temporary redirect.


# 3. How Rewrites/Request work

So when the front controller is dispatched and before matching the router to a URL it will try and match the URL to category or product and set an alias for standard router to use and also see if the URL type is custom and then redirect the user before the method match is called.


    Mage_Core_Controller_Varien_Front->dispatch();


**Overview:**

1. Calls the rewrite method in Mage_Core_Model_Url_Rewrite_Request
2. Checks if there is any database rewrites
4. If the rewrite is a system rewrite (e.g. catalog/product/view/id/1) then it will set an alias in the Request class Zend_Controller_Request_Http
5. If its custom and is a redirect then it will redirect the user to the target_path


### 3.1. Rewrite Method

When the Front Controller is being dispatched *Mage_Core_Controller_Varien_Front->dispatch();* it will call the following method before matching the URL with a router.

    $this->_getRequestRewriteController()->rewrite();

The rewrite method is called in *Mage_Core_Model_Url_Rewrite_Request*.

This then calls the method rewriteDb();


### 3.2 Get target paths

The method rewriteDb will then do the following:

1. Gets request paths which returns an array of paths (/ and no / at the end of the URL)
2. Loads "request_path" in Mage_Core_Model_Resource_Url_Rewrite->getRequestPathByIdPath($idPath, $store);

If there is no target_path and the URL is from switching store (__from_store) then Magento will try and load that store and set the target path.

At this point if there is no target path it will return false and the Default Router will output a 404 page.

## 3.3 Set Alias for Request

At this point the method then sets an Alias which is used by the Standard router to load the correct data.


    $this->_request->setAlias(Mage_Core_Model_Url_Rewrite::REWRITE_REQUEST_PATH_ALIAS,
    $this->_rewrite->getRequestPath());


Request class is Zend_Controller_Request_Http.

## 3.4 Redirect

So before the method then redirects any custom redirects before returning to the Request process.

This is done in the _processRedirectOptions() method.

So there are 2 redirect types:

1. RP - 301 redirect
2. R - 302 redirect

So this method will call _sendRedirectHeaders method and set the redirect header.


# 4. Category/Product URL Creation


# 4.1 Creating URL's


When you save a product for the first time and there is no value then the Request Path use the title and hyphenates it and lowercase it using this method

    Mage_Catalog_Model_Product_Url->formatKey($url);


This is the same for the category

    Mage_Catalog_Model_Category_Url->formatKey($url);


# 4.2. Configuration Options


System -> Configuration -> Catalog -> Search Engine Optimisations

1. Product URL Suffix - the suffix for product URLs - default ".html"
2. Category URL Suffix - the suffix for category URLs - default ".html"
3. Use Categories Path for Product URLs - Whether to allow category URL's created for a product - default "yes"
4. Create Permanent Redirect for URLs if URL Key Changed - If Magento should create Permanent redirects when you change a URL


System -> Configuration -> Web -> Search Engine Optimisations

1. Use Web Server Rewrites - Use mod_alias and remove index.php from URL's. - default = no.

# 5. Further Reading

- [http://blog.belvg.com/magento-certified-developer-exam-url-rewrites-part-i.html](http://blog.belvg.com/magento-certified-developer-exam-url-rewrites-part-i.html)
- [http://www.solvingmagento.com/magento-url-rewrites/](http://www.solvingmagento.com/magento-url-rewrites/)
- [http://alanstorm.com/magento_dispatch_rewrites_intro](http://alanstorm.com/magento_dispatch_rewrites_intro)
